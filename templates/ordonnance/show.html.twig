{% extends 'base.html.twig' %}

{% block title %}Ordonnances{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/medecin/dashboard.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/consultation/form.css') }}">
{% endblock %}

{% block body %}
<div class="portal">

    {% include 'side_bar.html.twig' %}

    <main class="portal__main">

        <header class="portal__header">
            <h1 class="portal__title">Toutes les ordonnances</h1>
            <p class="portal__subtitle">Liste des ordonnances avec actions.</p>
        </header>

        <section class="portal__content">
            <div style="margin-bottom:16px;display:flex;gap:12px;align-items:flex-end">
                <form method="get" style="display:flex;gap:8px;flex:1">
                    <input type="text" name="search" placeholder="Search by medicament, consultation, or date..." value="{{ search }}" style="padding:10px 12px;border:1px solid rgba(7,19,31,.10);border-radius:10px;flex:1;font-size:14px">
                    <select name="sort" style="padding:10px 12px;border:1px solid rgba(7,19,31,.10);border-radius:10px;font-size:14px">
                        <option value="date" {% if sort == 'date' %}selected{% endif %}>Le plus rÃ©cent en premier</option>
                        <option value="medicament" {% if sort == 'medicament' %}selected{% endif %}>MÃ©dicaments de A Ã  Z</option>
                        <option value="consultation" {% if sort == 'consultation' %}selected{% endif %}>Nom de la Consultation</option>
                    </select>
                    <button type="submit" class="btn btn--primary">Rechercher</button>
                    {% if search or sort != 'date' %}
                        <a href="{{ path('Ordonnance_show_all') }}" class="btn btn--ghost">RÃ©initialiser</a>
                    {% endif %}
                </form>
            </div>

            <div class="portal__card">
                <div class="box">
                    {% if ordonnances is empty %}
                        <p>Aucune ordonnance disponible.</p>
                    {% else %}
                        <table style="width:100%; border-collapse:collapse">
                            <thead>
                                <tr style="text-align:left; border-bottom:1px solid rgba(7,19,31,.08)">
                                    <th>Medicament</th>
                                    <th>Dosage</th>
                                    <th>DurÃ©e</th>
                                    <th>Consultation</th>
                                    <th>CrÃ©Ã©</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in ordonnances %}
                                    <tr style="border-bottom:1px solid rgba(7,19,31,.06)">
                                        <td>
                                            {% if o.medicaments|length > 0 %}
                                                {% set meds = [] %}
                                                {% for med in o.medicaments %}
                                                    {% set meds = meds|merge([med.medicament]) %}
                                                {% endfor %}
                                                {{ meds|join(', ') }}
                                            {% else %}
                                                {{ o.medicament ?: 'â€”' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if o.medicaments|length > 0 %}
                                                {% set dosages = [] %}
                                                {% for med in o.medicaments %}
                                                    {% set dosages = dosages|merge([med.dosage ?: 'â€”']) %}
                                                {% endfor %}
                                                {{ dosages|join(', ') }}
                                            {% else %}
                                                {{ o.dosage ?: 'â€”' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if o.medicaments|length > 0 %}
                                                {% set durees = [] %}
                                                {% for med in o.medicaments %}
                                                    {% set durees = durees|merge([med.duree ?: 'â€”']) %}
                                                {% endfor %}
                                                {{ durees|join(', ') }}
                                            {% else %}
                                                {{ o.duree ?: 'â€”' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if o.consultation %}
                                                {{ o.consultation.name }} {{ o.consultation.familyName }}
                                            {% else %}
                                                â€”
                                            {% endif %}
                                        </td>
                                        <td>{{ o.createdAt ? o.createdAt|date('Y-m-d') : 'â€”' }}</td>
                                        <td>
                                            {% if o.consultation %}
                                                <a href="{{ path('download_consultation_pdf', {'consultationId': o.consultation.id}) }}" class="btn btn--ghost" title="TÃ©lÃ©charger PDF" style="padding:6px 10px;font-size:16px">ðŸ“¥</a>
                                            {% endif %}
                                            <a href="{{ path('Ordonnance_show', {'id': o.id}) }}" class="btn btn--ghost">DÃ©tails</a>
                                            <a href="{{ path('Ordonnance_edit', {'id': o.id}) }}" class="btn btn--primary">Modifier</a>
                                            <form method="post" action="{{ path('Ordonnance_delete', {'id': o.id}) }}" style="display:inline">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ o.id) }}">
                                                <button type="submit" class="btn btn--ghost" onclick="return confirm('Supprimer cette ordonnance?')">Supprimer</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        </section>

    </main>

</div>
{% endblock %}