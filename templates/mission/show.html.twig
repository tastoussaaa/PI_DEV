{% extends 'base.html.twig' %}

{% block title %}D√©tails de la Mission{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/medecin/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        #map {
            height: 400px;
            border-radius: 8px;
            margin: 16px 0;
            border: 2px solid #ddd;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .detail-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .detail-section h3 {
            margin-top: 0;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
        }

        .detail-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn-back {
            padding: 12px 20px;
            background: #F5F5F5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-back:hover {
            background: #E8E8E8;
            border-color: #999;
        }

        .btn-success {
            padding: 12px 20px;
            background: #C8E6C9;
            color: #2E7D32;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-success:hover {
            background: #A5D6A7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
        }

        .btn-danger {
            padding: 12px 20px;
            background: #FFCCCC;
            color: #C62828;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-danger:hover {
            background: #FFADAD;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.2);
        }

        .btn-warning {
            padding: 12px 20px;
            background: #FFF9C4;
            color: #F57F17;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-warning:hover {
            background: #FFF59D;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 127, 23, 0.2);
        }

        .traceability-message {
            margin: 16px 0;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .traceability-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 280px;
            max-width: 420px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
            display: none;
        }

        .traceability-toast--success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .traceability-toast--error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        .traceability-message--success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .traceability-message--error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        .traceability-meta {
            margin: 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            background: #f9f9f9;
            border-left: 4px solid #13B8C2;
            font-size: 13px;
            color: #444;
        }

        .actions button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status--completed {
            background: #C8E6C9;
            color: #2E7D32;
            border: 1px solid rgba(46, 125, 50, 0.15);
        }

        .status--expired {
            background: #FFE0B2;
            color: #E65100;
            border: 1px solid rgba(230, 81, 0, 0.15);
        }

        .status--cancelled {
            background: #FFCDD2;
            color: #C62828;
            border: 1px solid rgba(198, 40, 40, 0.15);
        }
    </style>
{% endblock %}

{% block body %}

<div class="portal">
    <div id="traceabilityToast" class="traceability-toast"></div>

    {% include 'side_bar.html.twig' %}

    <main class="portal__main">
        <div class="portal__top">
            <div>
                <h1 class="portal__title">D√©tails de la mission</h1>
                <p class="portal__subtitle">Consultation et suivi de votre mission</p>
            </div>
        </div>

        <div class="box" style="max-width: 900px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                <div>
                    <h2 style="margin: 0 0 12px 0;">{{ demande.titreD }}</h2>
                    <span class="status-badge status--{{ demande.typeDemande|lower }}">{{ demande.typeDemande }}</span>
                </div>
                <div style="text-align: right;">
                    <h3 style="margin: 0 0 8px 0;">Statut</h3>
                    {% set statusClass = {
                        'ACCEPT√âE': 'accepted',
                        'EN_ATTENTE': 'en_attente',
                        'A_REASSIGNER': 'en_attente',
                        'REFUS√âE': 'refused',
                        'TERMIN√âE': 'completed',
                        'EXPIR√âE': 'expired',
                        'ANNUL√âE': 'cancelled'
                    }[demande.statut] ?? demande.statut|lower|replace({'_': '_'}) %}
                    <span class="status-badge status--{{ statusClass }}">{{ demande.statut|replace({'_': ' '}) }}</span>
                </div>
            </div>

            <div class="details-grid">
                <div class="detail-section">
                    <h3>üìã Informations g√©n√©rales</h3>
                    <div class="detail-item">
                        <div class="detail-label">Titre de la demande</div>
                        <div class="detail-value">{{ demande.titreD }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Description du besoin</div>
                        <div class="detail-value">{{ demande.descriptionBesoin }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Type de patient</div>
                        <div class="detail-value">{{ demande.typePatient|replace({'_': ' '}) }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sexe de l'aide soignant</div>
                        <div class="detail-value">
                            {% if demande.sexe == 'M' %}
                                Homme
                            {% elseif demande.sexe == 'F' %}
                                Femme
                            {% else %}
                                Peu importe
                            {% endif %}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Budget maximum</div>
                        <div class="detail-value">{{ demande.budgetMax }} DT</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üìÖ Dates et dur√©es</h3>
                    <div class="detail-item">
                        <div class="detail-label">Cr√©√©e le</div>
                        <div class="detail-value">{{ demande.dateCreation ? demande.dateCreation|date('d/m/Y √† H:i') : 'N/A' }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">D√©but mission (RDV)</div>
                        <div class="detail-value">{{ mission and mission.dateDebut ? mission.dateDebut|date('d/m/Y √† H:i') : (demande.dateDebutSouhaitee ? demande.dateDebutSouhaitee|date('d/m/Y √† H:i') : 'N/A') }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Fin souhait√©e</div>
                        <div class="detail-value">{{ demande.dateFinSouhaitee ? demande.dateFinSouhaitee|date('d/m/Y √† H:i') : 'Non d√©finie' }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Aide certifi√©e requise</div>
                        <div class="detail-value">
                            {% if demande.besoinCertifie %}
                                ‚úÖ Oui
                            {% else %}
                                ‚ùå Non
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if demande.lieu or (demande.latitude and demande.longitude) %}
                <div style="margin-bottom: 24px;">
                    <h3 style="margin-top: 0;">üìç Localisation</h3>
                    {% if demande.lieu %}
                        <p><strong>Lieu:</strong> {{ demande.lieu }}</p>
                    {% endif %}
                    <div id="map"></div>
                    <p style="font-size: 13px; color: #999; margin-top: 8px;">
                        Latitude: {{ demande.latitude|number_format(6) }}, Longitude: {{ demande.longitude|number_format(6) }}
                    </p>
                </div>
            {% endif %}

            <div id="traceabilityMessage" class="traceability-message"></div>

            {% if mission %}
                <div class="traceability-meta">
                    <strong>Tra√ßabilit√© mission:</strong>
                    Check-in: {{ mission.checkInAt ? mission.checkInAt|date('d/m/Y H:i:s') : 'Non effectu√©' }} |
                    Check-out: {{ mission.checkOutAt ? mission.checkOutAt|date('d/m/Y H:i:s') : 'Non effectu√©' }} |
                    V√©rification: {{ mission.statusVerification ?? 'PENDING' }}
                </div>
            {% endif %}

            {% if mission and (demande.statut == 'ACCEPT√âE' or mission.statutMission == 'ACCEPT√âE') and not mission.checkOutAt %}
                <div class="detail-section" style="margin-bottom: 12px;">
                    <h3>üìé Preuves optionnelles (check-out)</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label for="proofPhotoInput" style="display:block; font-weight:600; margin-bottom: 6px;">Photo preuve</label>
                            <input id="proofPhotoInput" type="file" accept="image/*" style="width:100%;">
                        </div>
                        <div>
                            <label for="signatureInput" style="display:block; font-weight:600; margin-bottom: 6px;">Signature (image)</label>
                            <input id="signatureInput" type="file" accept="image/*" style="width:100%;">
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="actions">
                <a href="{{ path('aidesoingnant_missions') }}" class="btn-back">‚Üê Retour</a>
                {% if mission and (demande.statut == 'ACCEPT√âE' or mission.statutMission == 'ACCEPT√âE') %}
                    <button
                        type="button"
                        id="checkinBtn"
                        class="btn-success"
                        data-url="{{ path('mission_checkin', {'id': mission.id}) }}"
                        {% if mission.checkInAt %}disabled{% endif %}
                    >üìç Check-in</button>
                    <button
                        type="button"
                        id="checkoutBtn"
                        class="btn-warning"
                        data-url="{{ path('mission_checkout', {'id': mission.id}) }}"
                        {% if not mission.checkInAt or mission.checkOutAt %}disabled{% endif %}
                    >‚úÖ Check-out</button>
                    {% if mission.checkOutAt %}
                        <a href="{{ path('mission_pdf_download', {'id': mission.id}) }}" class="btn-success" style="text-decoration: none;">
                            üìÑ T√©l√©charger PDF
                        </a>
                    {% endif %}
                    {% if mission.finalStatus != 'ANNUL√âE' %}
                        <form method="POST" action="{{ path('aidesoingnant_missions_cancel', {'id': demande.id}) }}" style="margin-left: auto; display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir annuler cette mission ?');">
                            <button type="submit" class="btn-danger" {% if mission.finalStatus %}disabled{% endif %}>‚úó Annuler</button>
                        </form>
                    {% endif %}
                {% elseif mission %}
                    <div style="background: #FFF9C4; padding: 12px 16px; border-radius: 6px; border-left: 4px solid #FBC02D; margin-left: auto;">
                        <strong style="color: #F57F17;">‚ö†Ô∏è Check-in/out disponible uniquement pour les missions accept√©es</strong>
                    </div>
                    {% if mission.finalStatus != 'ANNUL√âE' %}
                        <form method="POST" action="{{ path('aidesoingnant_missions_cancel', {'id': demande.id}) }}" style="display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir annuler cette mission ?');">
                            <button type="submit" class="btn-danger" {% if mission.finalStatus %}disabled{% endif %}>‚úó Annuler</button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    const mapElement = document.getElementById('map');
    if (mapElement) {
        const map = L.map('map').setView([{{ demande.latitude }}, {{ demande.longitude }}], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        L.marker([{{ demande.latitude }}, {{ demande.longitude }}]).addTo(map)
            .bindPopup('<b>{{ demande.lieu ?? 'Demande d\'aide' }}</b>');
    }

    function showTraceabilityMessage(type, message) {
        const messageBox = document.getElementById('traceabilityMessage');
        const toast = document.getElementById('traceabilityToast');

        if (!messageBox) return;

        messageBox.className = 'traceability-message';
        messageBox.classList.add(type === 'success' ? 'traceability-message--success' : 'traceability-message--error');
        messageBox.textContent = message;
        messageBox.style.display = 'block';

        if (toast) {
            toast.className = 'traceability-toast';
            toast.classList.add(type === 'success' ? 'traceability-toast--success' : 'traceability-toast--error');
            toast.textContent = message;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 3500);
        }
    }

    function getCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('La g√©olocalisation n\'est pas support√©e par votre navigateur.'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => resolve(position),
                (error) => {
                    if (error.code === error.PERMISSION_DENIED) {
                        reject(new Error('Vous devez autoriser la g√©olocalisation pour continuer.'));
                    } else {
                        reject(new Error('Impossible de r√©cup√©rer votre position actuelle.'));
                    }
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    }

    async function submitTraceabilityAction(buttonElement, actionLabel) {
        try {
            buttonElement.disabled = true;
            const originalText = buttonElement.textContent;
            buttonElement.textContent = actionLabel + ' en cours...';

            const position = await getCurrentPosition();
            const payload = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                consent: true
            };

            if (actionLabel === 'Check-out') {
                const proofPhotoInput = document.getElementById('proofPhotoInput');
                const signatureInput = document.getElementById('signatureInput');

                if (proofPhotoInput && proofPhotoInput.files && proofPhotoInput.files[0]) {
                    payload.proofPhotoData = await fileToDataUrl(proofPhotoInput.files[0]);
                }

                if (signatureInput && signatureInput.files && signatureInput.files[0]) {
                    payload.signatureData = await fileToDataUrl(signatureInput.files[0]);
                }
            }

            const response = await fetch(buttonElement.dataset.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(payload)
            });

            const rawBody = await response.text();
            let data = null;

            try {
                data = JSON.parse(rawBody);
            } catch (_e) {
                data = {
                    success: false,
                    message: response.ok
                        ? 'R√©ponse serveur invalide (JSON attendu).'
                        : 'Erreur serveur inattendue. Veuillez r√©essayer.'
                };
            }

            if (!response.ok || !data.success) {
                showTraceabilityMessage('error', data.message || 'Une erreur est survenue.');
                buttonElement.disabled = false;
                buttonElement.textContent = originalText;
                return;
            }

            showTraceabilityMessage('success', data.message || 'Action enregistr√©e avec succ√®s.');
            setTimeout(() => window.location.reload(), 1200);
        } catch (error) {
            showTraceabilityMessage('error', error.message || 'Une erreur est survenue.');
            buttonElement.disabled = false;
            if (actionLabel === 'Check-in') {
                buttonElement.textContent = 'üìç Check-in';
            } else {
                buttonElement.textContent = '‚úÖ Check-out';
            }
        }
    }

    const checkinBtn = document.getElementById('checkinBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('Impossible de lire le fichier de preuve.'));
            reader.readAsDataURL(file);
        });
    }

    if (checkinBtn) {
        checkinBtn.addEventListener('click', (event) => {
            event.preventDefault();
            submitTraceabilityAction(checkinBtn, 'Check-in');
        });
    }

    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', (event) => {
            event.preventDefault();
            submitTraceabilityAction(checkoutBtn, 'Check-out');
        });
    }

</script>
{% endblock %}
