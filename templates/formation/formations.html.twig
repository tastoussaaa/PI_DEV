{% extends 'base.html.twig' %}

{% block title %}Formations Disponibles
{% endblock %}

{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('assets/css/medecin/dashboard.css') }}">
	<style>

		/* ==============================
   SEARCH + FILTER BAR
============================== */

		.filter {
			background: rgba(255, 255, 255, .9);
			border: 1px solid var(--border);
			border-radius: 22px;
			padding: 18px;
			box-shadow: var(--shadow2);
			margin-bottom: 20px;
		}

		/* form layout */
		.filter form {
			display: flex;
			flex-wrap: wrap;
			gap: 14px;
			align-items: flex-end;
		}

		/* labels */
		.filter label {
			font-size: 12px;
			font-weight: 850;
			color: var(--muted);
			display: block;
			margin-bottom: 6px;
		}

		/* input + select wrapper */
		.filter .field {
			display: flex;
			flex-direction: column;
			min-width: 200px;
			flex: 1;
		}

		/* input + select style */
		.filter input,
		.filter select {
			padding: 10px 14px;
			border-radius: 14px;
			border: 1px solid var(--border);
			background: rgba(233, 253, 255, .55);
			font-size: 13px;
			font-family: inherit;
			transition: 0.18s ease;
		}

		/* focus effect */
		.filter input:focus,
		.filter select:focus {
			outline: none;
			border: 1px solid rgba(24, 191, 234, .4);
			box-shadow: 0 0 0 4px rgba(24, 191, 234, .12);
		}

		/* button spacing */
		.filter button {
			height: 42px;
			border-radius: 14px;
			padding: 0 18px;
		}


		.popup-success {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.4);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 9999;
		}

		.popup-content {
			background: white;
			padding: 25px;
			border-radius: 12px;
			width: 420px;
			text-align: center;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
		}

	</style>

{% endblock %}

{% block body %}

	{% set navigation = [
    {'name': 'Dashboard', 'path': path('app_medecin_dashboard'), 'icon': 'üè†'},
    {'name': 'Consultations', 'path': path('medecin_consultations'), 'icon': 'ü©∫'},
	{'name': 'Ordonnances', 'path': path('Ordonnance_new'), 'icon': 'üíä'},
    {'name': 'Formations', 'path': path('medecin_formations'), 'icon': 'üìö'},
    {'name': 'Nouvelle Formation', 'path': path('medecin_formation_new'), 'icon': '‚ûï'}
] %}

	<div class="portal">
		{% for data in app.flashes('formation_success') %}
			<div id="calendar-popup" class="popup-success">
				<div class="popup-content">
					<h3>‚úÖ Formation cr√©√©e avec succ√®s</h3>
					<p>Voulez-vous l'ajouter √† votre Google Calendar ?</p>

					<div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
						<a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ data.title|url_encode }}&details={{ data.description|url_encode }}&dates={{ data.start }}/{{ data.end }}" target="_blank" class="btn btn--primary">
							üóì Ajouter
						</a>


						<button onclick="closeCalendarPopup()" class="btn btn--ghost">
							Plus tard
						</button>
					</div>
				</div>
			</div>
		{% endfor %}

		{# Sidebar #}
		{% include 'side_bar.html.twig' %}

		<main class="portal__main">

			<div class="portal__top">
				<div>
					<h1 class="portal__title">Formations Disponibles</h1>
					<p class="portal__subtitle">Consultez et explorez toutes les formations disponibles</p>
				</div>

				{# Only M√©decin can create formation #}
				{% if current_user_type == 'medecin' %}
					<a href="{{ path('medecin_formation_new') }}" class="btn btn--primary">
						‚ûï Cr√©er une formation
					</a>
				{% endif %}
			</div>

			{# Filter by category #}
			<div class="filter">
				<form method="get" action="{% if current_user_type == 'medecin' %}{{ path('medecin_formations') }}{% else %}{{ path('aidesoignant_formations') }}{% endif %}">

					<div class="field">
						<label for="search">Rechercher par nom</label>
						<input type="text" name="search" id="search" placeholder="Nom de la formation" value="{{ searchTerm|default('') }}">
					</div>

					<div class="field">
						<label for="category">Filtrer par cat√©gorie</label>
						<select name="category" id="category">
							<option value="">Toutes</option>
							{% for cat in categories %}
								<option value="{{ cat }}" {% if cat == selectedCategory %} selected {% endif %}>
									{{ cat }}
								</option>
							{% endfor %}
						</select>
					</div>


				</form>
			</div>

			<div id="formations-container">
				{% if formations is empty %}
					<div class="box">
						<p>Aucune formation disponible pour le moment.</p>
					</div>
				{% else %}
					<div class="cards">
						<div class="cards__grid">

							{% for formation in formations %}
								<div class="card" onclick="window.location='{{ path('formation_details', {'id': formation.id}) }}';" style="cursor:pointer;">

									<h3>{{ formation.title }}</h3>

									{% set plainDescription = formation.description|striptags %}
									<p>
										{{ plainDescription|length > 100
                ? plainDescription|slice(0, 100) ~ '‚Ä¶'
                : plainDescription }}
									</p>

									<div class="card__footer">
										<span class="pill">{{ formation.category }}</span>
										<span>
											{{ formation.startDate ? formation.startDate|date('d/m/Y H:i') : '' }}
											-
											{{ formation.endDate ? formation.endDate|date('d/m/Y H:i') : '' }}
										</span>
									</div>

									
									{# ================= MEDECIN ================= #}
									{% if current_user_type == 'medecin' %}
										<div style="margin-top:15px;">
											<a
												href="{{ path('medecin_formation_applicants', {'id': formation.id}) }}" class="btn btn--secondary" style="width:100%; text-align:center;" onclick="event.stopPropagation();">
												{# stops card click #}
												üë• Voir les candidatures
											</a>
										</div>
									{% endif %}

								</div>
							{% endfor %}

						</div>
					</div>
				{% endif %}
			</div>

			{# BotMan Web Widget #}
			<style>
				#botmanWidgetRoot {
					z-index: 9999 !important;
				}
				#botmanWidgetRoot iframe {
					height: 450px !important;
					width: 350px !important;
				}
			</style>


			<script>
				document.addEventListener("DOMContentLoaded", function () {

const searchInput = document.getElementById("search");
const categorySelect = document.getElementById("category");
const container = document.getElementById("formations-container");

function fetchFormations() {
const searchValue = searchInput.value;
const categoryValue = categorySelect.value;

const url = new URL(window.location.href);
url.searchParams.set("search", searchValue);
url.searchParams.set("category", categoryValue);

fetch(url, {
headers: {
"X-Requested-With": "XMLHttpRequest"
}
}).then(response => response.text()).then(html => {
const parser = new DOMParser();
const doc = parser.parseFromString(html, "text/html");
const newContent = doc.getElementById("formations-container");
container.innerHTML = newContent.innerHTML;
});
}

// üî• Trigger on typing
searchInput.addEventListener("input", function () {
fetchFormations();
});

// üî• Trigger on category change
categorySelect.addEventListener("change", function () {
fetchFormations();
});

});
			</script>

			<script>
				var botmanWidget = {
frameEndpoint: '/botman',
title: 'Assistant Formation',
introMessage: "‚úã Bonjour ! Je peux vous aider √† trouver une formation.",
mainColor: '#18bfea',
bubbleBackground: '#18bfea',
frameEndpoint: '/botman',
aboutText: '',
bubbleAvatarUrl: ''
};
			</script>
			<script src="https://cdn.jsdelivr.net/npm/botman-web-widget@0/build/js/widget.js"></script>


			<script>
				function closeCalendarPopup() {
const popup = document.getElementById('calendar-popup');
if (popup) {
popup.style.display = 'none';
}
}
			</script>

		{% endblock %}
