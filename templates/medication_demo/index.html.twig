{% extends 'base.html.twig' %}

{% block title %}Medication Demo{% endblock %}

{% block body %}
  <h1>Medication Integration Demo</h1>

  <h2>FHIR (sample Patient)</h2>
  {% if fhir.error is defined %}
    <p><strong>Status:</strong> Could not load patient data — please try again.</p>
  {% elseif fhir.entry is defined and fhir.entry|length > 0 %}
    <p><strong>Status:</strong> Patient data found.</p>
  {% else %}
    <p><strong>Status:</strong> No patient data returned from the FHIR sandbox.</p>
  {% endif %}
  <pre>{{ fhir|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>

  <h2>RxNav (RxNorm lookup)</h2>
  {% if rx.error is defined %}
    <p><strong>Status:</strong> RxNorm lookup failed — try a different name.</p>
  {% elseif rx.idGroup is defined and rx.idGroup.rxnormId is defined and rx.idGroup.rxnormId|length > 0 %}
    <p><strong>Status:</strong> Drug found in RxNorm.</p>
  {% else %}
    <p><strong>Status:</strong> No RxNorm match found for that drug.</p>
  {% endif %}
  <pre>{{ rx|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>

  <h2>openFDA (label search)</h2>
  {% if fda.error is defined %}
    <p><strong>Status:</strong> openFDA request failed or rate-limited.</p>
  {% elseif fda.results is defined and fda.results|length > 0 %}
    <p><strong>Status:</strong> Label information found.</p>
  {% else %}
    <p><strong>Status:</strong> No label data returned from openFDA.</p>
  {% endif %}
  <pre>{{ fda|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>

  <p>Notes: Public APIs shown here are for demo only. Vendor APIs (Surescripts, RTBC) require sandbox credentials.</p>
  <h2>Mocks: RTBC & E-prescribe</h2>
  <div>
    <button id="rtbcBtn">Run Mock RTBC</button>
    <pre id="rtbcRes">(no result)</pre>
  </div>
  <div>
    <button id="eprescribeBtn">Send Mock E-prescribe</button>
    <pre id="eprescribeRes">(no result)</pre>
  </div>

  <script>
    document.getElementById('rtbcBtn').addEventListener('click', function(){
      const payload = { patient: { id: 'demo-123' }, medication: { rxcui: '1049630', name: 'metformin' } };
      fetch('/mock/rtbc', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(j => document.getElementById('rtbcRes').textContent = JSON.stringify(j, null, 2))
        .catch(e => document.getElementById('rtbcRes').textContent = 'Error: '+e);
    });

    document.getElementById('eprescribeBtn').addEventListener('click', function(){
      const xml = '<Prescription><patient id="demo-123"/><medication rxcui="1049630">metformin</medication></Prescription>';
      fetch('/mock/eprescribe', { method: 'POST', headers: {'Content-Type':'application/xml'}, body: xml })
        .then(r => r.text())
        .then(t => document.getElementById('eprescribeRes').textContent = t)
        .catch(e => document.getElementById('eprescribeRes').textContent = 'Error: '+e);
    });
  </script>
{% endblock %}
