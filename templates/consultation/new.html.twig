{% extends 'base.html.twig' %}

{% block title %}Nouvelle Consultation - AI Assist{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/medecin/dashboard.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/consultation/form.css') }}">
    <style>
        .motif-enhancement {
            margin-top: 12px;
            padding: 16px;
            background: #f0f7ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .motif-enhancement.loading {
            color: #0066cc;
            background: #e6f0ff;
            border-left-color: #0066cc;
        }
        .motif-enhancement.success {
            color: #155e3d;
            background: #d1f2eb;
            border-left-color: #2dbe60;
        }
        .motif-enhancement.error {
            color: #8e2424;
            background: #f5d5d5;
            border-left-color: #dc3545;
        }
        .motif-enhancement.warning {
            color: #856404;
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .enhancement-label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        .enhancement-content {
            font-style: italic;
            line-height: 1.5;
        }
        .enhance-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        .enhance-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .enhance-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .enhance-btn.loading {
            background: linear-gradient(135deg, #6b7c93 0%, #8899a6 100%);
        }
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .urgency-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .urgency-elevee {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .urgency-moderee {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .urgency-faible {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .original-motif {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ccc;
        }
        .severity-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .severity-mild { background: #d4edda; color: #155724; }
        .severity-moderate { background: #fff3cd; color: #856404; }
        .severity-severe { background: #f8d7da; color: #721c24; }
        .validation-error {
            color: #dc3545;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f8d7da;
            border-radius: 4px;
            border-left: 3px solid #dc3545;
        }
    </style>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('assets/js/consultation-slots.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ü§ñ OpenAI Enhancement script loaded');
            
            // Find the motif input - try multiple selectors
            let motifInput = document.querySelector('input[name*="motif"]') || 
                            document.querySelector('#consultation_type_motif') ||
                            document.querySelector('[id*="motif"]');
            
            console.log('Motif input found:', motifInput);
            
            if (!motifInput) {
                console.error('Could not find motif input field');
                return;
            }

            // Create enhancement container
            const motifField = motifInput.closest('.form__field') || motifInput.parentElement;
            
            // Create the enhancement panel
            const enhancementPanel = document.createElement('div');
            enhancementPanel.id = 'motif-enhancement-panel';
            enhancementPanel.style.display = 'none';
            enhancementPanel.innerHTML = `
                <div class="motif-enhancement" id="motif-enhancement">
                    <span class="enhancement-label" id="enhancement-label">
                        <span class="ai-badge">ü§ñ AI Assistant</span>
                        <span id="urgency-badge"></span>
                    </span>
                    <div class="enhancement-content" id="enhancement-content"></div>
                </div>
            `;
            
            // Insert after motif field
            if (motifField && motifField.parentElement) {
                motifField.parentElement.insertBefore(enhancementPanel, motifField.nextSibling);
            } else {
                motifInput.parentElement.appendChild(enhancementPanel);
            }

            // Create enhance button
            const enhanceBtn = document.createElement('button');
            enhanceBtn.type = 'button';
            enhanceBtn.className = 'enhance-btn';
            enhanceBtn.id = 'enhance-btn';
            enhanceBtn.innerHTML = '‚ú® Analyser avec IA';
            enhanceBtn.title = 'Cliquez pour analyser votre motif avec l\'IA';
            
            // Insert button after motif input
            motifInput.parentElement.insertBefore(enhanceBtn, motifInput.nextSibling);

            const enhancementDiv = document.getElementById('motif-enhancement');
            const enhancementContent = document.getElementById('enhancement-content');
            const urgencyBadge = document.getElementById('urgency-badge');
            const enhancementLabel = document.getElementById('enhancement-label');

            // Function to get urgency display text
            function getUrgencyText(urgency) {
                const urgencyTexts = {
                    'elevee': 'üö® Urgence √©lev√©e',
                    'moderee': '‚ö†Ô∏è Urgence mod√©r√©e',
                    'faible': '‚úÖ Routine / Faible'
                };
                return urgencyTexts[urgency] || '‚ö†Ô∏è Urgence mod√©r√©e';
            }

            // Function to call OpenAI API using new comprehensive endpoint
            function callOpenAI(motif) {
                enhancementPanel.style.display = 'block';
                enhancementDiv.className = 'motif-enhancement loading';
                enhanceBtn.className = 'enhance-btn loading';
                enhanceBtn.disabled = true;
                enhanceBtn.innerHTML = '‚è≥ Analyse en cours...';
                
                // Hide urgency badge during loading
                urgencyBadge.innerHTML = '';
                
                console.log('Calling OpenAI API with motif:', motif);
                
                // Use the new comprehensive analysis endpoint
                fetch('/consultation/analyze-motif?motif=' + encodeURIComponent(motif))
                    .then(response => {
                        console.log('OpenAI response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('OpenAI data:', data);
                        enhanceBtn.className = 'enhance-btn';
                        enhanceBtn.disabled = false;
                        
                        if (data.ok) {
                            // Show urgency level
                            const urgencyClass = 'urgency-' + (data.urgency || 'moderee');
                            urgencyBadge.className = 'urgency-badge ' + urgencyClass;
                            urgencyBadge.innerHTML = getUrgencyText(data.urgency);
                            
                            if (!data.isValid) {
                                // Motif is not valid/understandable - show error/warning
                                enhancementDiv.className = 'motif-enhancement warning';
                                enhancementContent.innerHTML = `
                                    <div class="validation-error">
                                        <strong>‚ö†Ô∏è Motif incompr√©hensible</strong><br>
                                        ${data.message || 'Veuillez entrer un motif de consultation clair et comprehensible.'}
                                    </div>
                                    <div class="original-motif">
                                        <strong>Votre message:</strong> "${motif}"
                                    </div>
                                    <p style="margin-top: 10px; color: #666; font-size: 13px;">
                                        üí° <strong>Conseils:</strong> D√©crivez vos sympt√¥mes clairement (ex: "J'ai mal √† la t√™te depuis 2 jours", "Fi√®vre et toux depuis une semaine")
                                    </p>
                                `;
                                enhanceBtn.innerHTML = 'üîÑ R√©essayer';
                            } else if (data.enhanced && data.enhanced !== motif) {
                                // Valid and enhanced
                                enhancementDiv.className = 'motif-enhancement success';
                                enhancementContent.innerHTML = `
                                    <div class="enhancement-content">
                                        <strong>Version am√©lior√©e:</strong><br>
                                        <span style="color: #155e3d; font-size: 15px;">"${data.enhanced}"</span>
                                    </div>
                                    <div class="original-motif">
                                        <strong>Original:</strong> "${motif}"
                                    </div>
                                    <button type="button" class="enhance-btn" onclick="applyEnhancement('${data.enhanced.replace(/'/g, "\\'")}')" style="margin-top: 10px;">
                                        ‚úÖ Utiliser cette version
                                    </button>
                                `;
                                enhanceBtn.innerHTML = 'üîÑ Re-analyser';
                            } else {
                                // Valid but no enhancement needed
                                enhancementDiv.className = 'motif-enhancement';
                                enhancementContent.innerHTML = `
                                    <span class="enhancement-label">‚úÖ Parfait!</span>
                                    <span class="enhancement-content">Votre description est claire et bien structur√©e.</span>
                                `;
                                enhanceBtn.innerHTML = '‚ú® Re-analyser';
                            }
                            
                            // Update message if provided
                            if (data.message && data.isValid) {
                                enhancementContent.innerHTML += `<p style="margin-top: 8px; font-size: 13px; color: #666;">${data.message}</p>`;
                            }
                        } else {
                            // API error
                            enhancementDiv.className = 'motif-enhancement error';
                            enhancementContent.innerHTML = `
                                <span class="enhancement-label">‚ö†Ô∏è Service IA indisponible</span>
                                <span class="enhancement-content">${data.message || data.error || 'L\'enhancement AI n\'est pas configur√©. Veuillez v√©rifier la cl√© API OpenAI.'}</span>
                            `;
                            enhanceBtn.innerHTML = '‚ö†Ô∏è R√©essayer';
                        }
                    })
                    .catch(error => {
                        console.error('OpenAI fetch error:', error);
                        enhancementDiv.className = 'motif-enhancement error';
                        enhanceBtn.className = 'enhance-btn';
                        enhanceBtn.disabled = false;
                        enhancementContent.innerHTML = `
                            <span class="enhancement-label">‚ö†Ô∏è Erreur de connexion</span>
                            <span class="enhancement-content">${error.message}</span>
                        `;
                        enhanceBtn.innerHTML = '‚ö†Ô∏è R√©essayer';
                    });
            }

            // Button click handler
            enhanceBtn.addEventListener('click', function() {
                const motif = motifInput.value.trim();
                if (!motif || motif.length < 3) {
                    alert('Veuillez d\'abord entrer un motif de consultation (au moins 3 caract√®res).');
                    motifInput.focus();
                    return;
                }
                callOpenAI(motif);
            });

            // Also trigger on blur for convenience
            motifInput.addEventListener('blur', function() {
                const motif = this.value.trim();
                if (motif && motif.length >= 3 && enhancementPanel.style.display === 'none') {
                    // Auto-show hint that enhancement is available
                    enhanceBtn.style.animation = 'pulse 2s infinite';
                }
            });

            // Remove pulse animation when user clicks the button
            enhanceBtn.addEventListener('click', function() {
                this.style.animation = 'none';
            });
        });

        function applyEnhancement(enhancedText) {
            console.log('Applying enhancement:', enhancedText);
            const motifInput = document.querySelector('input[name*="motif"]') || 
                              document.querySelector('#consultation_type_motif') ||
                              document.querySelector('[id*="motif"]');
            if (motifInput) {
                motifInput.value = enhancedText;
                motifInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Show success feedback
                const panel = document.getElementById('motif-enhancement-panel');
                if (panel) {
                    panel.style.display = 'none';
                }
                
                // Show confirmation
                alert('‚úÖ Version am√©lior√©e appliqu√©e!');
            }
        }
    </script>
{% endblock %}

{% block body %}
<div class="portal">

    <!-- SIDEBAR -->
    {% include 'side_bar.html.twig' %}

    <!-- MAIN CONTENT -->
    <main class="portal__main">

        <header class="portal__header">
            <h1 class="portal__title">
                Nouvelle consultation
                <span class="ai-badge">ü§ñ AI Assist</span>
            </h1>
            <p class="portal__subtitle">
                Remplissez les d√©tails de la consultation soigneusement. 
                Utilisez le bouton <strong>"Analyser avec IA"</strong> pour:
                <ul style="margin-top: 8px; color: #666;">
                    <li>‚úì Valider que votre motif est compr√©hensible</li>
                    <li>‚úì Obtenir une description m√©dicalement pr√©cise</li>
                    <li>‚úì √âvaluer le niveau d'urgence de votre consultation</li>
                </ul>
            </p>
        </header>

        <section class="portal__content portal__card">

            {{ form_start(form, {'attr': {'class': 'form', 'novalidate': 'novalidate'}}) }}

                <div class="form__fields" id="consultation-form-fields">
                    {{ form_row(form.dateConsultation) }}
                    {{ form_row(form.timeSlot) }}
                    {% include 'consultation/slots-helper.html.twig' %}
                    {{ form_row(form.motif) }}
                    {{ form_row(form.name) }}
                    {{ form_row(form.familyName) }}
                    {{ form_row(form.email) }}
                    {{ form_row(form.sex) }}
                    {{ form_row(form.age) }}
                </div>

                <div class="form__actions">
                    <a href="{{ path('patient_consultations') }}" class="btn btn--ghost" role="button" aria-label="Cancel and go back">
                        Annuler
                    </a>
                    <button type="submit" class="btn btn--primary" title="Save consultation">
                        Cr√©er
                    </button>
                </div>

            {{ form_end(form) }}

        </section>

    </main>
</div>
{% endblock %}
